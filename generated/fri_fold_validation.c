/**
 * fri_fold_validation.c - Validation Test for Generated FRI Fold
 *
 * This file contains test vectors generated by Lean to validate
 * that the generated C code produces correct results.
 *
 * Generated by: AmoLean.FRI.Validation
 * Design Decision: DD-005 (Translation Validation)
 *
 * Compile:
 *   clang -DFIELD_NATIVE -DDEBUG -fsanitize=address,undefined \
 *         -I. -o fri_validation fri_fold_validation.c
 *
 * Run:
 *   ./fri_validation
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdint.h>

/* Define via compiler flags: -DFIELD_NATIVE -DDEBUG
 * or uncomment below for standalone compilation */
#ifndef FIELD_NATIVE
#define FIELD_NATIVE
#endif
#ifndef DEBUG
#define DEBUG
#endif

#include "field_ops.h"
#include "fri_fold.h"

#define MAX_SIZE 1024

typedef struct {
    const char* name;
    size_t size;
    uint64_t even[MAX_SIZE];
    uint64_t odd[MAX_SIZE];
    uint64_t alpha;
    uint64_t expected[MAX_SIZE];
} TestCase;

static const TestCase test_cases[] = {
    // Test: small_n4
    {
        .name = "small_n4",
        .size = 4,
        .even = {1, 2, 3, 4},
        .odd = {10, 20, 30, 40},
        .alpha = 2,
        .expected = {21, 42, 63, 84}
    },
    // Test: alpha_zero
    {
        .name = "alpha_zero",
        .size = 4,
        .even = {100, 200, 300, 400},
        .odd = {1, 2, 3, 4},
        .alpha = 0,
        .expected = {100, 200, 300, 400}
    },
    // Test: alpha_one
    {
        .name = "alpha_one",
        .size = 4,
        .even = {10, 20, 30, 40},
        .odd = {1, 2, 3, 4},
        .alpha = 1,
        .expected = {11, 22, 33, 44}
    },
    // Test: medium_n16
    {
        .name = "medium_n16",
        .size = 16,
        .even = {1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16},
        .odd = {10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 110, 120, 130, 140, 150, 160},
        .alpha = 3,
        .expected = {31, 62, 93, 124, 155, 186, 217, 248, 279, 310, 341, 372, 403, 434, 465, 496}
    },
    // Test: larger_n64
    {
        .name = "larger_n64",
        .size = 64,
        .even = {0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63},
        .odd = {64, 63, 62, 61, 60, 59, 58, 57, 56, 55, 54, 53, 52, 51, 50, 49, 48, 47, 46, 45, 44, 43, 42, 41, 40, 39, 38, 37, 36, 35, 34, 33, 32, 31, 30, 29, 28, 27, 26, 25, 24, 23, 22, 21, 20, 19, 18, 17, 16, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1},
        .alpha = 7,
        .expected = {448, 442, 436, 430, 424, 418, 412, 406, 400, 394, 388, 382, 376, 370, 364, 358, 352, 346, 340, 334, 328, 322, 316, 310, 304, 298, 292, 286, 280, 274, 268, 262, 256, 250, 244, 238, 232, 226, 220, 214, 208, 202, 196, 190, 184, 178, 172, 166, 160, 154, 148, 142, 136, 130, 124, 118, 112, 106, 100, 94, 88, 82, 76, 70}
    },
    // Test: power2_n256
    {
        .name = "power2_n256",
        .size = 256,
        .even = {0, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32, 34, 36, 38, 40, 42, 44, 46, 48, 50, 52, 54, 56, 58, 60, 62, 64, 66, 68, 70, 72, 74, 76, 78, 80, 82, 84, 86, 88, 90, 92, 94, 96, 98, 100, 102, 104, 106, 108, 110, 112, 114, 116, 118, 120, 122, 124, 126, 128, 130, 132, 134, 136, 138, 140, 142, 144, 146, 148, 150, 152, 154, 156, 158, 160, 162, 164, 166, 168, 170, 172, 174, 176, 178, 180, 182, 184, 186, 188, 190, 192, 194, 196, 198, 200, 202, 204, 206, 208, 210, 212, 214, 216, 218, 220, 222, 224, 226, 228, 230, 232, 234, 236, 238, 240, 242, 244, 246, 248, 250, 252, 254, 256, 258, 260, 262, 264, 266, 268, 270, 272, 274, 276, 278, 280, 282, 284, 286, 288, 290, 292, 294, 296, 298, 300, 302, 304, 306, 308, 310, 312, 314, 316, 318, 320, 322, 324, 326, 328, 330, 332, 334, 336, 338, 340, 342, 344, 346, 348, 350, 352, 354, 356, 358, 360, 362, 364, 366, 368, 370, 372, 374, 376, 378, 380, 382, 384, 386, 388, 390, 392, 394, 396, 398, 400, 402, 404, 406, 408, 410, 412, 414, 416, 418, 420, 422, 424, 426, 428, 430, 432, 434, 436, 438, 440, 442, 444, 446, 448, 450, 452, 454, 456, 458, 460, 462, 464, 466, 468, 470, 472, 474, 476, 478, 480, 482, 484, 486, 488, 490, 492, 494, 496, 498, 500, 502, 504, 506, 508, 510},
        .odd = {0, 3, 6, 9, 12, 15, 18, 21, 24, 27, 30, 33, 36, 39, 42, 45, 48, 51, 54, 57, 60, 63, 66, 69, 72, 75, 78, 81, 84, 87, 90, 93, 96, 99, 102, 105, 108, 111, 114, 117, 120, 123, 126, 129, 132, 135, 138, 141, 144, 147, 150, 153, 156, 159, 162, 165, 168, 171, 174, 177, 180, 183, 186, 189, 192, 195, 198, 201, 204, 207, 210, 213, 216, 219, 222, 225, 228, 231, 234, 237, 240, 243, 246, 249, 252, 255, 258, 261, 264, 267, 270, 273, 276, 279, 282, 285, 288, 291, 294, 297, 300, 303, 306, 309, 312, 315, 318, 321, 324, 327, 330, 333, 336, 339, 342, 345, 348, 351, 354, 357, 360, 363, 366, 369, 372, 375, 378, 381, 384, 387, 390, 393, 396, 399, 402, 405, 408, 411, 414, 417, 420, 423, 426, 429, 432, 435, 438, 441, 444, 447, 450, 453, 456, 459, 462, 465, 468, 471, 474, 477, 480, 483, 486, 489, 492, 495, 498, 501, 504, 507, 510, 513, 516, 519, 522, 525, 528, 531, 534, 537, 540, 543, 546, 549, 552, 555, 558, 561, 564, 567, 570, 573, 576, 579, 582, 585, 588, 591, 594, 597, 600, 603, 606, 609, 612, 615, 618, 621, 624, 627, 630, 633, 636, 639, 642, 645, 648, 651, 654, 657, 660, 663, 666, 669, 672, 675, 678, 681, 684, 687, 690, 693, 696, 699, 702, 705, 708, 711, 714, 717, 720, 723, 726, 729, 732, 735, 738, 741, 744, 747, 750, 753, 756, 759, 762, 765},
        .alpha = 5,
        .expected = {0, 17, 34, 51, 68, 85, 102, 119, 136, 153, 170, 187, 204, 221, 238, 255, 272, 289, 306, 323, 340, 357, 374, 391, 408, 425, 442, 459, 476, 493, 510, 527, 544, 561, 578, 595, 612, 629, 646, 663, 680, 697, 714, 731, 748, 765, 782, 799, 816, 833, 850, 867, 884, 901, 918, 935, 952, 969, 986, 1003, 1020, 1037, 1054, 1071, 1088, 1105, 1122, 1139, 1156, 1173, 1190, 1207, 1224, 1241, 1258, 1275, 1292, 1309, 1326, 1343, 1360, 1377, 1394, 1411, 1428, 1445, 1462, 1479, 1496, 1513, 1530, 1547, 1564, 1581, 1598, 1615, 1632, 1649, 1666, 1683, 1700, 1717, 1734, 1751, 1768, 1785, 1802, 1819, 1836, 1853, 1870, 1887, 1904, 1921, 1938, 1955, 1972, 1989, 2006, 2023, 2040, 2057, 2074, 2091, 2108, 2125, 2142, 2159, 2176, 2193, 2210, 2227, 2244, 2261, 2278, 2295, 2312, 2329, 2346, 2363, 2380, 2397, 2414, 2431, 2448, 2465, 2482, 2499, 2516, 2533, 2550, 2567, 2584, 2601, 2618, 2635, 2652, 2669, 2686, 2703, 2720, 2737, 2754, 2771, 2788, 2805, 2822, 2839, 2856, 2873, 2890, 2907, 2924, 2941, 2958, 2975, 2992, 3009, 3026, 3043, 3060, 3077, 3094, 3111, 3128, 3145, 3162, 3179, 3196, 3213, 3230, 3247, 3264, 3281, 3298, 3315, 3332, 3349, 3366, 3383, 3400, 3417, 3434, 3451, 3468, 3485, 3502, 3519, 3536, 3553, 3570, 3587, 3604, 3621, 3638, 3655, 3672, 3689, 3706, 3723, 3740, 3757, 3774, 3791, 3808, 3825, 3842, 3859, 3876, 3893, 3910, 3927, 3944, 3961, 3978, 3995, 4012, 4029, 4046, 4063, 4080, 4097, 4114, 4131, 4148, 4165, 4182, 4199, 4216, 4233, 4250, 4267, 4284, 4301, 4318, 4335}
    },
};

static const size_t NUM_TESTS = sizeof(test_cases) / sizeof(test_cases[0]);

int run_test(const TestCase* tc) {
    printf("  Testing: %s (size=%zu)\n", tc->name, tc->size);

    uint64_t* output = malloc(tc->size * sizeof(uint64_t));
    if (!output) {
        printf("    FAIL: Memory allocation failed\n");
        return 0;
    }

    // Run the generated FRI fold
    fri_fold(tc->size, tc->even, tc->odd, output, tc->alpha);

    // Compare with expected
    int pass = 1;
    for (size_t i = 0; i < tc->size; i++) {
        if (output[i] != tc->expected[i]) {
            printf("    FAIL at index %zu: got %llu, expected %llu\n",
                   i, (unsigned long long)output[i],
                   (unsigned long long)tc->expected[i]);
            pass = 0;
        }
    }

    free(output);

    if (pass) {
        printf("    PASS\n");
    }
    return pass;
}

int main(void) {
    printf("╔══════════════════════════════════════════════════════════════╗\n");
    printf("║     FRI FOLD VALIDATION (Lean → C)                           ║\n");
    printf("╚══════════════════════════════════════════════════════════════╝\n");
    printf("Field: %s\n\n", FIELD_NAME);

    int all_pass = 1;
    size_t passed = 0;

    for (size_t i = 0; i < NUM_TESTS; i++) {
        if (run_test(&test_cases[i])) {
            passed++;
        } else {
            all_pass = 0;
        }
    }

    printf("\n");
    printf("Results: %zu/%zu tests passed\n", passed, NUM_TESTS);

    if (all_pass) {
        printf("══════════════════════════════════════════════════════════════\n");
        printf("VALIDATION PASSED: Generated C matches Lean spec\n");
        printf("══════════════════════════════════════════════════════════════\n");
        return 0;
    } else {
        printf("══════════════════════════════════════════════════════════════\n");
        printf("VALIDATION FAILED: Discrepancy between Lean and C\n");
        printf("══════════════════════════════════════════════════════════════\n");
        return 1;
    }
}
